

# 📚 17차시 학습 노트 (최종 통합본: n8n Agents)

## 🎯 이번 차시의 목표

안녕하세요, 여러분\! 16차시에서 우리는 **Next.js 웹 폼(광고주)**, **Flutter C\&C 앱(관리자)**, 그리고 **(중요) 광고 단가와 퍼포먼스 데이터가 포함된 Supabase RAG DB**, **S3** 등 모든 인프라와 클라이언트 구축을 완료했습니다.

이제 17차시에서는 이 모든 인프라를 실제로 연결하고 작동시키는 **3개의 핵심 AI Agent**를 n8n으로 구현합니다. 특히 Agent 2는 16차시에 구축한 DB의 \*\*정량 데이터(단가, CPM)와 정성 데이터(벡터)\*\*를 모두 활용하는 **'하이브리드 매칭 로직'** 을 수행합니다.

-----

## ⚙️ 전체 워크플로우 한눈에 보기

1.  **(입력)** 광고주가 **Next.js 폼**에 브리프(**예산, 목표 CPM/CTR, 인구통계** 포함)를 제출, S3 `new/` 폴더에 **JSON 파일**이 업로드됩니다.
2.  **(Agent 1: 분석)** n8n이 1분마다 S3를 감지(Polling)합니다. S3에서 JSON 파일을 읽어 **정량적 목표(예산, CPM 등)** 를 추출하고, `details` 필드를 LLM으로 요약하여 `summary`를 생성합니다. 결과를 Supabase DB에 `status='pending_approval'`로 저장하고 **Telegram 알림**을 보냅니다.
3.  **(승인 1: HITL)** 관리자가 알림을 받고 **Flutter C\&C 앱**을 엽니다. AI 분석 내용(**광고주 목표 스펙**)을 검토한 뒤 [✅ 1차 승인] 버튼을 누릅니다.
4.  **(Agent 2: 하이브리드 매칭)** Flutter 앱이 Agent 2의 웹훅을 호출합니다.
      * **1) 정량 필터링 (SQL):** n8n이 Supabase `youtubers` 테이블에서 **예산, 목표 CPM/CTR, 인구통계**를 만족하는 유튜버 후보군을 **먼저 필터링**합니다.
      * **2) 정성 매칭 (RAG):** n8n이 **필터링된 후보군 내에서만** RAG 벡터 검색을 수행하여, **캠페인 의도**와 가장 잘 맞는 유튜버 1\~3명을 찾습니다.
      * **3) 통합 선택 및 제안서 생성 (AI):** AI가 후보 수를 자동 판단하여 비교 분석 후 최적 1명을 선정, 후보 비교 분석과 최종 추천 사유를 포함한 제안서를 작성합니다.
      * 구조화된 JSON 출력(`winner_json`, `proposal_markdown`)을 파싱하여 DB에 `status='pending_proposal_approval'`로 저장하고 **Telegram 알림**을 보냅니다.
5.  **(승인 2: HITL)** 관리자가 **Flutter C\&C 앱**에서 AI 제안서(성과 기반 매칭 사유 포함)를 검토하고 [✍️ 2차 승인] 버튼을 누릅니다.
6.  **(Agent 3: 계약 및 마무리)** Flutter 앱이 Agent 3의 웹훅을 호출합니다. n8n이 AI로 계약서(Markdown)를 생성(**선택된 유튜버 1명의 할당 예산** 명시)하고 DB에 저장한 뒤, **즉시 마무리 로직을 실행**합니다.
7.  **(마무리 로직 - Agent 3에 포함)** **Agent 3**가 이어서 계약서를 **PDF로 변환**하여 S3에 저장합니다. DB 상태를 `status='completed'`로 변경하고, PDF 다운로드 링크가 포함된 **최종 Telegram 알림**을 전송합니다. Flutter 앱에도 '완료' 상태가 실시간 반영됩니다.

-----

## 17-1. Agent 1: 광고 기획서 분석

첫 번째 Agent는 S3 버킷을 감시하다가 새 브리프 파일이 들어오면, AI로 내용을 분석하고 관리자에게 1차 승인을 요청하는 역할을 합니다.

### ➡️ 1. 트리거: S3 신규 파일 감지 (Polling)

1.  **`Schedule Trigger`:** `Mode: Every 1 Minute`
2.  **`AWS S3` (List Files):** `Prefix: campaign-briefs/new/`
3.  **`IF`:** `{{ $items.length }} > 0` (새 파일이 있을 때만 실행)
4.  **`SplitInBatches`:** `Batch Size: 1` (파일별로 개별 처리)

### 🧠 2. 핵심 로직: JSON 파싱 및 요약 생성

5.  **`AWS S3` (Read File):** `Key: {{ $json.key }}` (JSON 파일 본문 로드)
6.  **`Set` (Parse JSON):** S3에서 읽은 JSON 문자열을 파싱하여 객체로 변환
      * `parsedData: {{ $node["AWS S3"].json.data | binaryToText | parseJson }}`
7.  **`OpenAI` (Generate Summary):** `details` 필드를 LLM으로 요약하여 `summary` 생성 (아래 프롬프트 참조)

#### 🤖 Agent 1: Summary 생성 프롬프트

> **SYSTEM**
> 너는 광고 캠페인 브리프의 상세 내용을 요약하는 AI다.
>
> **USER**
> 아래 캠페인 정보를 바탕으로 이 캠페인의 핵심 의도(intent)를 1\~2 문장으로 요약해줘.
>
> [캠페인 정보]
>
>   - **회사명:** {{ $node["Set"].json.parsedData.companyName }}
>   - **제품/서비스:** {{ $node["Set"].json.parsedData.productName }}
>   - **상세 내용:** {{ $node["Set"].json.parsedData.details }}
>
> **[중요]** 응답은 반드시 요약 텍스트만 반환하며, 다른 말은 하지 마.

8.  **`Set` (Combine Analysis):** JSON 데이터와 요약을 결합
      * `ai_analysis: {{ { ...$node["Set"].json.parsedData, summary: $node["OpenAI"].json.choices[0].message.content } }}`
9.  **`Supabase` (Save State):**
      * `Table: campaigns`
      * `Columns:` `s3_key: {{ $node["AWS S3"].json.key }}`, `ai_analysis: {{ $node["Set"].json.ai_analysis }}`, `status: pending_approval`

### 🏁 3. 마무리: 파일 이동 및 알림

10. **`AWS S3` (Move File):** `New Key: campaign-briefs/processed/{{ $json.key.split('/').pop() }}` (처리 완료 폴더로 이동)
11. **`Telegram` (Send Notification):**
      * **Text:** `🔔 새 캠페인 접수 ({{ $node["AWS S3"].json.key.split('/').pop() }})! 승인을 위해 C&C 대시보드 앱을 확인하세요.`

-----

## 17-2. Agent 2: 유튜버 매칭 및 제안서 제작

두 번째 Agent는 Flutter 앱의 '1차 승인'을 받아, **(1) 정량 필터링** 후 **(2) 정성 RAG 매칭**을 수행하는 핵심 로직을 담당합니다.

### ➡️ 1. 트리거: Flutter 앱 1차 승인 (Webhook)

1.  **`Webhook` (Trigger):**
      * `HTTP Method: POST`
      * `Webhook URL:` `.../webhook/17-2-approve` (**16차시 Flutter 앱**이 1차 승인 시 호출)
2.  **`Set` (Parse ID):** `campaign_id: {{ $json.body.campaign_id }}` (Flutter 앱이 보낸 ID 파싱)
3.  **`Supabase` (Get Data):** `Select`, `Table: campaigns`, `Filter: id eq {{ $node["Set"].json.campaign_id }}` (캠페인 상세 정보 로드)

### 🧠 2. 핵심 로직 (1): 정량 필터링 (SQL)

4.  **`Supabase` (Filter Candidates):**
      * **Operation: `Select`**
      * **Table: `youtubers`**
      * **(핵심) `Filters` (UI 빌더 또는 SQL 사용):**
          * `cost_per_video_usd` **`lte`** `{{ $node["Supabase"].json[0].ai_analysis.budgetUSD }}`
          * `AND` `main_demographics` **`eq`** `{{ $node["Supabase"].json[0].ai_analysis.targetDemographics }}`
          * `AND` (If `targetCPM` is not null): `avg_cpm` **`lte`** `{{ $node["Supabase"].json[0].ai_analysis.targetCPM }}`
          * `AND` (If `targetCTR` is not null): `avg_ctr_percent` **`gte`** `{{ $node["Supabase"].json[0].ai_analysis.targetCTR }}`
      * (이 노드의 결과로 '예산과 성과 목표를 만족하는 유튜버 리스트'가 나옵니다.)

### 🧠 3. 핵심 로직 (2): 정성 매칭 (RAG)

5.  **`IF`:** `{{ $items.length }} > 0` (정량 필터링 결과가 1개 이상일 때만 RAG 수행)
6.  **`Set` (Prepare for RAG):**
      * `query_text: {{ $node["Supabase"].json[0].ai_analysis.summary }}`
      * `candidate_ids: {{ $node["Supabase (Filter Candidates)"].items.map(item => item.id) }}` (필터링된 유튜버 ID 목록)
7.  **`HTTP Request` (openai embedding):** (RPC에 텍스트가 아닌 벡터를 전달해야 하므로, OpenAI 임베딩 API 직접 호출)

      * `Authentication: Predefined Credential Type`
      * `Credential for 'openAiApi':` (n8n에 등록된 OpenAI Credentials 선택)
      * `Method: POST`
      * `URL: https://api.openai.com/v1/embeddings`
      * `Send Body: true`
      * **`Body Parameters` (UI Mode):**
          * `model: text-embedding-3-small`
          * `input: {{ $node["Set (Prepare for RAG)"].json.query_text }}` (Expression)

8.  **`HTTP Request` (Call Supabase RPC):**

      * **(중요)** n8n의 기본 `Supabase Vector Store` 노드 대신, 16차시에 생성한 `match_documents_by_ids` RPC 함수를 직접 호출합니다.
      * `Authentication: Predefined Credential`, `Credential: Supabase API` (n8n에 등록된 Supabase Credentials 선택)
      * `Method: POST`
      * `URL: (Supabase Project URL)/rest/v1/rpc/match_documents_by_ids`
      * `Body Content Type: JSON`
      * **`Body` (JSON):**
        ```json
        {
          "query_embedding": [{{ $node["OpenAI (Create Embedding)"].json.data[0].embedding }}],
          "match_count": 3,
          "filter_ids": {{ $node["Set (Prepare for RAG)"].json.candidate_ids }}
        }
        ```
      * (이 노드는 `Supabase (Filter Candidates)`가 반환한 `filter_ids` 목록 내에서만 벡터 검색을 수행하여 1\~3명의 후보를 **JSON 배열**로 반환합니다.)
      * **반환 데이터 (Body)**: `[{ "id": ..., "content": "...", "metadata": { "channel_id": "..." }, "similarity": 0.822 }, ...]`

9.  **`Supabase` (Get Full Specs):** (8번 RPC 결과의 `metadata.channel_id`를 이용해 `youtubers` 테이블에서 최종 상세 스펙(단가, CPM, CTR, 채널명)을 다시 조회)

      * (n8n의 자동 반복 실행으로 아이템별로 처리됨)
      * `Operation: Select`, `Table: youtubers`
      * `Filter: id eq {{ $json.metadata.channel_id }}`

10. **`Set` (Combine Data):** (8번 RPC 결과의 `content`, **`similarity`** 와 9번의 유튜버 스펙을 조합하여 중간 데이터 구조 생성)

11. **`OpenAI` (Generate Summary & Reason):** (각 유튜버에 대해 `content_summary`와 `reason` 생성)

#### 🤖 Agent 2 (Summary & Reason): 프롬프트 (JSON 생성)

> **SYSTEM**
> 너는 유튜버 광고 매칭 플랫폼의 AI 에이전트다. **단일 유튜버**의 원본 소개글과 캠페인 정보를 바탕으로, 요약(`content_summary`)과 선정 사유(`reason`)를 생성해야 한다.
>
> **USER**
> **[유튜버 정보 및 캠페인 목표 (JSON 객체 1개)]**
> (11번 노드에서 조합된 단일 유튜버 데이터가 삽입됩니다)
>
> ```json
> {
>   "channel_name": "Elanvital AI",
>   "content": "AI와 n8n을 활용한 실무 업무 자동화(RPA) 전문가. RAG, LLM 등 최신 AI 기술을 비개발자도 이해하기 쉽게 설명하며, 실제 기업 컨설팅 사례를 바탕으로 한 전문적이고 깊이 있는 튜토리얼을 제공합니다.",
>   "cost_per_video_usd": 5000,
>   "avg_cpm": 15000,
>   "avg_ctr_percent": 3.5,
>   "rag_similarity": 0.8215,
>   "target_cpm": 20000,
>   "target_ctr": 3.0
> }
> ```
>
> **[Task]**
> 위의 **단일 유튜버**에 대해:
>
> 1.  `content_summary`: 원본 소개글(`content`)을 1-2문장으로 요약하여 핵심 특징을 간결하게 표현
> 2.  `reason`: 다음 **세 가지**를 모두 포함한 선정 사유를 생성:
>       * **정성적(의미) 부합**: 캠페인 의도와 유튜버 채널의 특성이 어떻게 일치하는지
>       * **정량적(성과) 근거**: 목표 CPM(`target_cpm`) 및 CTR(`target_ctr`) 대비 유튜버의 성과 지표(`avg_cpm`, `avg_ctr_percent`)가 어떻게 만족하는지
>       * **(중요) 정성적(유사도) 점수**: RAG 검색의 `rag_similarity` 점수를 소수점 셋째 자리까지 반올림하여 "(유사도: X.XXX)" 형식으로 `reason` 텍스트에 포함.
>
> **[중요]** 응답은 반드시 다음 **JSON 객체 1개** 형식이어야 하며, 다른 말은 하지 마.
>
> ```json
> {
>   "channel_name": "Elanvital AI",
>   "content_summary": "AI, n8n, 업무 자동화 전문가로, 캠페인 의도와 일치함.",
>   "cost_per_video_usd": 5000,
>   "avg_cpm": 15000,
>   "avg_ctr_percent": 3.5,
>   "similarity": 0.8215,
>   "reason": "캠페인의 'AI를 활용한 업무 자동화 툴 리뷰' 의도와 100% 일치하며(유사도: 0.822), 목표 CPM(20000) 및 CTR(3.0)을 완벽히 만족합니다."
> }
> ```

### 🧠 4. 핵심 로직 (3): 통합 선택 및 제안서 생성

**12. `OpenAI` (Select, Propose & Structure Output):** (상황 판단, 최적 후보 선택, 제안서 생성 및 구조화된 출력)

  * **(n8n 처리)** 11번 노드까지의 자동 반복 실행이 완료되면, n8n은 **반복 실행된 결과(개별 JSON 객체 아이템)들을 자동으로 취합**하여 12번 노드에 **'멀티 아이템(배열)'** 형태로 전달합니다.
  * **입력**: 11번 노드에서 개별 생성된 JSON 객체 아이템들의 배열 (1개 또는 여러 개의 후보)
  * **출력**: 구조화된 JSON 객체 (`winner_json`과 `proposal_markdown` 포함)
  * **프롬프트**: 아래 🤖 **(Select, Propose & Structure)** 프롬프트 참조

#### 🤖 Agent 2 (Select, Propose & Structure Output): 프롬프트

> **SYSTEM**
> 너는 최고 수준의 광고 캠페인 전략가다. AI가 분석한 유튜버 후보 리스트(`[AI 분석 후보 리스트]`)와 캠페인 원본 정보(`[광고주 캠페인 정보]`, `[캠페인 목표]`)를 바탕으로, 관리자에게 제출할 **매우 상세하고 풍부한 '종합 협업 제안서'** 를 작성해야 한다.
>
> 응답은 **반드시** 지정된 JSON 형식으로만 출력해야 한다.
>
> **USER**
> **[캠페인 목표]**
>
>   * **총 예산 (USD):** {{ $node["Supabase"].json[0].ai\_analysis.budgetUSD }}
>   * **목표 CPM:** {{ $node["Supabase"].json[0].ai\_analysis.targetCPM }}
>   * **목표 CTR:** {{ $node["Supabase"].json[0].ai\_analysis.targetCTR }}
>
> **[광고주 캠페인 정보]**
>
>   * **회사명:** {{ $node["Supabase"].json[0].ai\_analysis.companyName }}
>   * **제품명:** {{ $node["Supabase"].json[0].ai\_analysis.productName }}
>
> **[AI 분석 후보 리스트 (JSON 배열)]**
> (8-2번 노드에서 생성된 JSON 배열이 삽입됩니다. 이 배열에는 1개 또는 여러 개의 후보가 포함될 수 있습니다.)
>
> ```json
> {{ $node["OpenAI (Generate Summary & Reason)"].json.choices[0].message.content }}
> ```
>
> -----
>
> **[Task]**
>
> **1. 최적 후보 1인 선정 (및 데이터 수정)**
>
>   * `[AI 분석 후보 리스트]`와 `[캠페인 목표]`를 비교 분석하여, 모든 지표(예산, 성과, 유사도)를 고려한 **최적의 후보 1명**을 선정한다.
>
>   * 선정된 1명의 JSON 객체를 `winner_json` 값으로 사용하되, **다음 [데이터 수정 규칙]을 반드시 적용한다.**
>
>   * **[데이터 수정 규칙]**
>
>     1.  **`original_cost_per_video_usd`**: 유튜버의 **원본 단가**(원본 `cost_per_video_usd` 값)를 이 **새 필드**에 복사한다.
>     2.  **`cost_per_video_usd`**: 이 필드의 값을 `[캠페인 목표]`의 **'총 예산 (USD)'** 값으로 덮어쓴다. (이것이 Flutter 앱에 표시될 **'집행 예산'** 이 된다.)
>
> **2. '종합 제안서' (Markdown) 생성**
>
>   * **(중요)** 아래 명시된 **'종합 보고서 양식'** 을 **반드시** 준수하여 `proposal_markdown` 값을 생성한다.
>   * 모든 정보는 `[광고주 캠페인 정보]`, `[캠페인 목표]`, `[AI 분석 후보 리스트]`에서 가져와야 한다.
>
> **[종합 보고서 양식]**
>
> ```markdown
> # 유튜버 협업 제안서
> [회사명] – *[제품명] 런칭 캠페인*
> ```
>
> -----
>
> ## 1\. 제안 개요
>
> 본 제안서는 [회사명]의 신규 [제품명] 초기 인지도 확보를 목표로, 데이터 기반으로 정성적 적합도, 정량 성과 지표, AI 콘텐츠 유사도를 종합 평가하여 최적의 유튜버를 추천합니다.
>
> -----
>
> ## 2\. 예산 요약 (USD)
>
>   * 총 예산: [캠페인 목표의 총 예산]
>   * **권장 집행안 (최종 선정)**
>       * [winner\_json의 channel\_name]: **[캠페인 목표의 총 예산 (USD)]** \>       - 잔여 예산: **0**
>
> -----
>
> ## 3\. (중요) 후보 상세 분석
>
> (AI 분석 후보 리스트의 **모든 후보**를 여기에 상세히 기술한다. 후보가 1명이면 1명만 기술한다.)
>
> ### 3.1 [후보 1의 channel\_name]
>
> **비용: [후보 1의 cost\_per\_video\_usd] USD**
> **평균 CPM: [후보 1의 avg\_cpm]**
> **평균 CTR: [후보 1의 avg\_ctr\_percent]%**
> **콘텐츠 유사도: [후보 1의 similarity]**
>
> #### 추천 이유
>
> [후보 1의 `reason` 필드 내용을 여기에 그대로 삽입한다. 이 'reason'에는 11 노드에서 생성된 정성/정량/유사도 근거가 이미 포함되어 있어야 한다.]
>
> ### 3.2 [후보 2의 channel\_name]
>
> (후보 2가 있다면 동일하게 작성)
>
> -----
>
> ## 4\. 최종 추천 전략 및 사유
>
> `(후보가 2명 이상일 경우에만 이 섹션을 작성한다. 1명일 경우 생략)`
>
> `[AI 분석 후보 리스트]를 바탕으로 'winner_json'이 다른 후보 대비 **'종합 성과 (성과 지표, 콘텐츠 유사도, 원본 단가 기반 효율성 등)'** 측면에서 왜 더 우수한지 비교 분석한다.`
>
> `**(중요)** 최종 결론으로, **'가장 우수한 1인'** 에게 **'총 예산 ({{ $node["Supabase"].json[0].ai_analysis.budgetUSD }} USD)'** 을 모두 집행하여, 예산을 분산하는 것보다 더 큰 캠페인 효과(Maximizing Impact)를 기대하는 전략임을 명시한다.`
>
> `(예: Level99은 원본 단가(6.5k) 대비 성과 지표(CTR 2.29%, 유사도 0.34)가 Boss03(14.5k, 2.09%, 0.258) 대비 월등히 우수합니다. 따라서 가장 적합한 Level99에게 총 예산 15,000 USD를 모두 배정하여 캠페인 성과를 극대화하는 것을 제안합니다.)`
>
> ## 5\. 결론
>
> 상기 분석(콘텐츠 적합도, 성과 지표, AI 유사도)을 바탕으로, [제품명] 캠페인의 초기 성과 확보에 **[winner\_json의 channel\_name]** 이(가) 가장 적합하다고 판단하여 최종 추천합니다.
>
> ```
> 
> **3. 최종 응답 (Structured Output)**
> ```
>
>   * **[중요]** 다른 말은 절대 하지 말고, **반드시** 아래 형식의 **JSON 객체** 1개만 반환하라.
>
> <!-- end list -->

> ```json
> {
>   "winner_json": {
>     "channel_name": "Level99 게임",
>     "content_summary": "신작 게임 리뷰, 고난이도 공략 전문 채널.",
>     "original_cost_per_video_usd": 6500,
>     "cost_per_video_usd": 15000,
>     "avg_cpm": 20630,
>     "avg_ctr_percent": 2.29,
>     "similarity": 0.34,
>     "reason": "신작 게임 소개 및 FPS 실전 팁 중심...(11번 노드에서 생성된 상세 사유)...(유사도: 0.340) ... 효율적."
>   },
>   "proposal_markdown": "# 유튜버 협업 제안서\n플레이어스튜디오 – *모바일 RPG ‘드래곤식스’ 런칭 캠페인*\n\n---\n\n## 1. 제안 개요\n...\n\n## 2. 예산 요약 (USD)\n\n- 총 예산: 15000\n- 권장 집행안 (최종 선정)\n  - Level99 게임: 15000\n  - 잔여 예산: 0\n\n---\n\n## 3. 후보 상세 분석\n\n### 3.1 Level99 게임\n**비용: 6500 USD**\n...\n#### 추천 이유\n신작 게임 소개 및 FPS 실전 팁 중심...(8-2 노드에서 생성된 상세 사유)...\n\n### 3.2 Boss03 게임\n**비용: 14500 USD**\n...\n#### 추천 이유\ne스포츠 및 신작 공략 분석 중심...(8-8 노드에서 생성된 상세 사유)...\n\n---\n\n## 4. 최종 추천 전략 및 사유\n\nBoss03 게임 대비 Level99 게임이 예산 효율성($6,500 vs $14,500)과 CTR(2.29% vs 2.09%)에서 우수하여 최종 선정했습니다.\n\n## 5. 결론\n...\n"
> }
> ```

### 🧠 5. 핵심 로직 (4): 데이터 파싱 및 저장 준비

**13. `Set` (Parse Data):** (12번 단계의 구조화된 출력을 파싱하여 변수 할당)

  * `parsed_output: {{ $node["OpenAI (Select, Propose & Structure Output)"].json.choices[0].message.content | parseJson }}`
  * `generated_proposal: {{ $node["Set"].json.parsed_output.proposal_markdown }}`
  * `matched_youtubers: {{ $node["Set"].json.parsed_output.winner_json }}`

### 🏁 6. 마무리: DB 저장 및 알림

**14. `Supabase` (Save Proposal):**
      * `Operation: Update`, `Table: campaigns`
      * `Columns:`
          * `matched_youtubers: {{ $node["Set"].json.matched_youtubers }}`
          * `generated_proposal: {{ $node["Set"].json.generated_proposal }}`
          * `status: pending_proposal_approval` (상태 변경)
**15. `Telegram` (Send Notification):**
      * **Text:** `📝 1차 승인 완료. (성과 기반) 제안서가 생성되었습니다. C&C 대시보드 앱에서 검토하세요.`

-----

## 17-3. Agent 3: 계약서 생성

세 번째 Agent는 Flutter 앱으로부터 '2차 승인' 신호를 받아 **'할당된 예산(단가)'** 이 명시된 계약서를 생성하고, **즉시 PDF 변환 및 최종 알림까지 모두 처리**합니다.

### ➡️ 1. 트리거: Flutter 앱 2차 승인 (Webhook)

1.  **`Webhook` (Trigger):** `.../webhook/17-3-contract` (**16차시 Flutter 앱**이 2차 승인 시 호출)
2.  **`Set` (Parse ID):** `campaign_id: {{ $json.body.campaign_id }}`
3.  **`Supabase` (Get Data):** (17-2와 동일하게 캠페인 정보 로드, `ai_analysis`와 `matched_youtubers` 포함)

### 🧠 2. 핵심 로직: AI 계약서 생성

4.  **`OpenAI` (Generate Contract):** (AI가 표준 용역 계약서 Markdown 생성)

#### 🤖 Agent 3 (Contract): 프롬프트 (Markdown 생성)

> **SYSTEM**
> 너는 법무팀 AI다. 광고 캠페인 정보를 바탕으로 표준 용역 계약서 초안을 Markdown으로 생성해야 한다.
>
> **USER**
> **[캠페인 정보 (갑: 광고주)]**
>
>   * **회사명:** {{ $node["Supabase"].json[0].ai\_analysis.companyName }}
>   * **제품/서비스:** {{ $node["Supabase"].json[0].ai\_analysis.productName }}
>   * **총 예산 (USD):** {{ $node["Supabase"].json[0].ai\_analysis.budgetUSD }}
>
> **[협업 대상 (을: 유튜버) 및 용역비]**
> (17-2에서 저장한 `matched_youtubers` 단일 JSON 객체. 여기에는 **원본 단가**와 최종 **집행 예산**이 모두 포함되어 있다.)
>
> ```json
> {{ $node["Supabase"].json[0].matched_youtubers }}
> ```
>
> **[Task]**
>
> 1.  위 정보를 바탕으로 **"광고 캠페인 용역 계약서"** 를 Markdown 형식으로 작성해라.
> 2.  "갑"(광고주)과 "을"(유튜버 1명)을 명시해라.
> 3.  **(중요) 계약의 목적 (제품 광고)과 '계약 금액'을 명시해야 한다.**
> 4.  **'계약 금액'** 항목에는 [협업 대상] JSON의 **`cost_per_video_usd`** 필드 값을 **최종 용역비(지급액)** 로 명확히 기술해야 한다. (`original_cost_per_video_usd`는 참고용 원본 단가이며, 실제 지급액은 `cost_per_video_usd`이다.)
> 5.  계약 기간, 비밀 유지 조항 등 표준 계약서 항목을 포함해라.

### 🏁 3. 마무리: DB 저장, PDF 생성 및 최종 보고

5.  **`Supabase` (Save Contract Draft):**
      * `Operation: Update`, `Table: campaigns`
      * `Columns:` `generated_contract: {{ $node["OpenAI"].json.choices[0].message.content }}`
6.  **`Set` (Format for PDF Backend):** (13차시 백엔드 스펙에 맞게 JSON 포맷팅)
      * `markdownContent: {{ $node["OpenAI"].json.choices[0].message.content }}`
7.  **`HTTP Request` (Call PDF Backend):**
      * `URL: (13차시 Render/Cloud Run 배포 URL)/generate`
      * (결과: `{ "bucket": "...", "key": "reports/report-uuid.pdf" }` 수신)
8.  **`Supabase` (Update State):**
      * `Operation: Update`, `Table: campaigns`
      * `Columns:` `status: completed`, `final_contract_s3_key: {{ $node["HTTP Request"].json.key }}`
9.  **`AWS S3` (Create Pre-signed URL):**
      * `Operation: Get`, `Key: {{ $node["HTTP Request"].json.key }}`, `Return: URL` (15분 유효 보안 링크 생성)
10. **`Telegram` (Final Report & Send Link):**
      * **Text:** `✅ 모든 작업 완료! PDF 계약서가 생성되었습니다. (15분간 유효) {{ $node["AWS S3"].json.url }}`
      * *(Flutter 앱은 Supabase Stream을 통해 자동으로 "completed" 상태로 업데이트됩니다.)*

-----

## 17-4. [최종] n8n 자동화 워크플로우 완성

이제 16차시에서 만든 모든 클라이언트(Next.js, Flutter)와 17차시에서 만든 n8n Agent들을 모두 연결하여 최종 테스트를 진행합니다. 

1.  **광고주 (Web):** 16차시 Vercel에 배포된 **Next.js 폼**에 접속하여 캠페인 브리프를 제출합니다.
      * **(테스트 데이터)** 예산: $10,000, 타겟: MALE\_20-30, 목표 CPM: 20,000 이하, 목표 CTR: 3.0% 이상, 의도: "AI를 활용한 업무 자동화 툴 리뷰"
2.  **(대기 1분)**
3.  **관리자 (Telegram):** `🔔 새 캠페인 접수...` **알림**을 받습니다. (Agent 1 동작)
4.  **관리자 (Mobile):** 16차시에 만든 **Flutter C\&C 앱**을 엽니다. 'pending\_approval' 상태의 새 항목을 확인합니다.
5.  **관리자 (Mobile):** 해당 항목을 탭하여 AI가 추출한 **'정량 목표'** (예산 $10k, CPM 20k, CTR 3.0%)를 확인하고 [✅ 1차 승인] 버튼을 누릅니다.
6.  **(대기)** (Agent 2가 **하이브리드 매칭** 수행: 
      * 정량 필터링: 'Elanvital AI'와 '테크긱'은 통과, '머니트렌드'는 예산 초과(12k)로 탈락, '게임마스터'는 인구통계/CPM/CTR 불일치로 탈락
      * 정성 매칭(RAG): 필터링된 후보 중 'Elanvital AI'가 유사도 0.822로 가장 높음
      * 통합 선택 및 제안서 생성: AI가 복수 후보를 비교 분석하여 'Elanvital AI' 1명을 최종 선택, 후보 비교 분석과 최종 추천 사유를 포함한 제안서 생성)
7.  **관리자 (Telegram):** `📝 1차 승인 완료...` **알림**을 받습니다. (Agent 2 동작)
8.  **관리자 (Mobile):** **Flutter 앱**의 해당 항목이 'pending\_proposal\_approval'로 실시간 변경된 것을 확인합니다. 탭하여 AI가 생성한 제안서를 검토합니다.
      * **(확인)** 제안서에 **"후보 비교 분석"** 섹션이 포함되어 있는지 확인합니다. (복수 후보인 경우)
      * **(확인)** 제안서에 "'Elanvital AI': 캠페인 의도 100% 일치(유사도: 0.822), 목표 CPM(15k)/CTR(3.5%) 달성"과 같은 **데이터 기반 매칭 사유**가 포함되어 있는지 확인합니다.
      * **(확인)** `matched_youtubers`가 **단일 JSON 객체**로 저장되어 Flutter 앱에 표시되는지 확인합니다.

9.  **관리자 (Mobile):** 제안서 검토 후 [✍️ 2차 승인] 버튼을 누릅니다.
10. **(대기)**
11. **관리자 (Telegram):** `✅ 모든 작업 완료!...` **최종 알림**과 함께 PDF 다운로드 **보안 링크**를 받습니다. (**Agent 3**가 계약서 생성, PDF 변환, 최종 보고까지 모두 완료)
12. **DB (Supabase):** `campaigns` 테이블을 확인하여 `status`가 `completed`이고 `generated_contract`에 선택된 유튜버('Elanvital AI')의 단가가 명시되어 있는지 최종 확인합니다. `matched_youtubers`가 **단일 JSON 객체**로 저장되어 있는지도 확인합니다.