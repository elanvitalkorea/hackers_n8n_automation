
## 8-1 시나리오 설명 및 n8n 기초

###  시나리오 설명
![hackers_8th_01](https://hackers-n8n-lecture.s3.ap-northeast-2.amazonaws.com/images/hackers_8th_01.png)
- 테크 4개 RSS 피드를 받아 최신 TOP 3 을 가져옴
- 기사 요약과 이미지 생성 두가지를 생성하여 google sheet에 기록
- Discord 통해 Human in the loop 로 승인 기다림
- 승인 하면 google sheet 에 approve 기록, 리젝인 경우 reject 기록 
- 실제 X Post는 하지 않음
	- 컨텐츠 모으는 행위와 게시는 실제적으로는 분리해서 사용 필요
	- discord , 텔레그램  메신저나 메일 Posting이 안전
#### SNS 자동화 유의사항  
- SNS 들은 자동화 탐지 알고리즘들이 활성화 되어 있음
- **메타계열** 자동화로 인한 계정 BAN 사례들 유의  (Instagram , Thread, Facebook)
- X나 linkedIn 도 마찬가지로 POST 행위는 신중히 필요. 특히 **LinkedIn** 자동화에 제일 엄격함  
- 과도한 댓글, 이모지, DM 등의 Write 행위 문제 됨
- DM, comment 의 리드는 괜찮음
- 또한 단순 POST도 짧은시간에 대량 게시가 아니라면 문제 없음  
- 자동화 POST는 하루 2~3회 이내로 줄임


### n8n 기초 설명
- 기본 단축키
- node connection 끊고, 이어붙이기
- pin 처리
- output edit
	- trigger_node
- 하단 history
- 부분 tidy up
- data search ( 전체 노드에서 변수 찾기) 
- copy json 
- set node
	- dot notation

### n8n Expressions

n8n Expression은 **JavaScript 문법과 특별한 변수**를 사용해 워크플로우 데이터를 실시간으로 제어하는 핵심 기능입니다. `{{ }}` 안에 코드를 작성하여 노드 간 데이터를 연결하고, 동적으로 값을 생성하며, 원하는 형태로 가공할 수 있습니다.

#### 1\. 데이터 접근의 두 가지 방법: Dot vs Bracket Notation

n8n에서도 JavaScript와 동일하게 객체 데이터에 접근하는 두 가지 방식을 모두 사용할 수 있습니다.

  * **Dot Notation (`.`):** 키 이름이 간단할 때 사용하며, 가장 일반적이고 직관적입니다.

    ```javascript
    {{ $json.title }} // 'title'이라는 키의 값을 가져옴
    ```

  * **Bracket Notation (`[]`):** 키 이름에 **공백, 특수문자**가 포함되거나 **변수**를 키로 사용해야 할 때 필수적입니다.

    ```javascript
    // 키에 공백이 있는 경우
    {{ $json["Article Title"] }}

    // 변수에 담긴 키 이름을 사용해야 할 때
    {{ $json[fieldName] }} // fieldName이라는 변수 값에 해당하는 키의 값을 가져옴
    ```

-----

#### 2\. 핵심 데이터 변수: 흐름과 맥락을 이해하라

| 변수 | 핵심 개념 | 대표 사용 사례 | 예시 (워크플로우 기반) |
| :--- | :--- | :--- | :--- |
| **`$json`** | **가장 가까운 입력.** `바로 이전 노드`에서 들어온 **첫 번째 아이템**의 `json` 바디. 가장 많이 쓰입니다. | 이전 노드의 결과값을 즉시 사용 | `Read RSS Feed` 노드에서 URL 값 가져오기<br>`{{ $json.rss }}` |
| **`$('Node Name')`** | **원거리 지정.** 워크플로우 내 `특정 노드`의 데이터를 이름으로 직접 지정하여 가져옵니다. | 여러 단계 전의 데이터가 필요할 때 | `Google Sheets` 노드에서 `Add Contents` 노드의 ID 값 참조<br>`{{ $('Add Contents').item.json.ID }}` |
| **`.item`** | **현재 반복 아이템.** `Loop Over Items` 같은 반복(Looping) 노드와 함께 사용되어, **현재 처리 중인 개별 아이템**을 가리킵니다. | 반복문 안에서 각 아이템 처리 | `Generate an image` 노드에서 반복 중인 기사의 snippet 참조<br>`{{ $('Loop Over Items').item.json.contentSnippet }}` |
| **`$items`** | **전체 아이템 배열.** 특정 노드에서 나온 **모든 아이템의 배열**을 가져옵니다. `map`, `filter` 등 JS 배열 메서드와 함께 쓰기 좋습니다. | 여러 아이템을 한 번에 가공/요약 | `(예시)` 모든 기사 제목을 합쳐 하나의 텍스트 만들기<br>`{{ $items("Read RSS Feed").map(item => item.json.title).join(", ") }}` |

-----

#### 3\. JavaScript의 힘을 극대화하기: 함수와 연산자

Expression은 단순한 값 참조를 넘어, JavaScript의 모든 기능을 활용하여 데이터를 동적으로 가공하는 데 그 진가가 있습니다.

  * **문자열 처리 (`.replace`, `.split`, `.includes` 등):**
    파일 이름을 만들거나 특정 텍스트를 파싱할 때 필수적입니다.

    ```javascript
    // 파일명으로 부적합한 문자를 제거
    {{ $json.title.replace(/[^\\w.-]/g, '') }}
    ```

  * **조건부 로직 (삼항 연산자 `? :`):**
    `IF` 노드를 쓰기엔 간단한 분기 처리를 인라인으로 해결할 수 있습니다.

    ```javascript
    // 링크에 특정 파라미터가 있으면 변경, 없으면 그대로 사용
    {{ $json.link.includes('param') ? $json.link.replace('param', 'new') : $json.link }}
    ```

  * **수학/날짜 연산:**
    n8n의 내장 `$now` 변수(Luxon 객체)를 활용해 날짜를 포맷팅하거나 고유 ID를 생성합니다.

    ```javascript
    // 고유 ID 생성
    {{ $now.toMillis() }}

    // 날짜 포맷팅
    {{ $now.setZone('Asia/Seoul').toFormat('yyyy-MM-dd HH:mm') }}
    ```

-----

#### 4\. 알아두면 유용한 추가 변수 및 컨텍스트

| 구분 | 설명 | 예시 |
| :--- | :--- | :--- |
| **`$env`** | n8n 환경 변수(Environment Variables)에 접근합니다. API 키 등 민감한 정보를 코드에 직접 노출하지 않을 때 사용합니다. | `{{ $env.MY_API_KEY }}` |
| **`$workflow`** | 현재 실행 중인 워크플로우의 메타데이터(ID, 이름 등)에 접근합니다. | `{{ $workflow.name }}` |
| **`$runIndex`** | 워크플로우가 여러 아이템을 처리할 때, 현재 몇 번째 아이템을 실행 중인지 인덱스(0부터 시작)를 반환합니다. | `{{ $runIndex }}` |



## 8-2 구글 인증 방법
- https://console.cloud.google.com
- project 생성 및 셋업 
	- CARD 입력 하지만 실제 빌링되지 않음
	- 300 달러 무료로 주어짐
- API & Services
	- Google Sheets API 
	- Google Drive API
- Consent screen 최초 셋업
	- API & Services -> OAuth consent screen
	- Get Started
	- App Information : n8n cred
	- Email 입력
	- Audience : External
	- Contact 정보 
- Consent Audience
	- API & Services -> OAuth consent screen
	- Audience 사이드바 선택
	- Test user에 본인 이메일 입력
- Create Credentials 
	- API & Services -> Credentials 
	- + Create credentials 드롭다운 -> oauth client ID
	- type web application
	- name : n8n hostinger
	- Authorized redirect URIs
		- `https://n8n.srv1044808.hstgr.cloud/rest/oauth2-credential/callback`
	- Create 
	- 팝업 생성 됨
		- 이 창에서 반드시 secret 기록 + download JSON 해야됨. 없어짐
- Authorized domains
	- Google Auth Platform -> Branding 
	- Authorized domains 자동 추가된 것 확인 
- google credenital 만드는 곳에서
	- Client ID, Secret 입력후 **Google Signin** 누름 
	- continue 선택
	- 함수 OK

![hackers_8th_02](https://hackers-n8n-lecture.s3.ap-northeast-2.amazonaws.com/images/hackers_8th_02.png)

## 8-3 discord 인증 
- discord 장점
	- 모바일, 웹, 데스크탑 어디서든 쉽게 실행
		- 걸어다니는 자동화 가능
	- 무료 
	- 자동화하기 쉬움 n8n과 좋은 궁합
	- slack이 많이 쓰이나 유료임, 텔레그램도 많이 쓰임
	- slack으로도 방식이 많이 유사해서 응용 가능
- discord 설치
	- `https://discord.com/download`
- server 추가 하기
	- + 버튼
	- 직접만들기 -> 나와 친구들을 위한 서버
	- 서버 이름 입력 
- 채팅 채널 추가하기
	- 채팅채널 에서 + 선택
- https://discord.com/developers
	- get started
	- https://discord.com/developers/applications
- New Application
![hackers_8th_03](https://hackers-n8n-lecture.s3.ap-northeast-2.amazonaws.com/images/hackers_8th_03.png)

### Bot Token 방식 

#### 서버에 앱 설치 
- OAuth2 사이드 메뉴 진입
- SCOPES -> bot  only 선택
- BOT PERMISSIONS
	- Admin 혹은 , TEXT PERMISSIONS 필요 내용 선별
- GENERATED URL 복사
	- 가장 하단에 생김 
- 브라우저에서 해당 URL 실행
	- 대상 서버 선택 
	- 퍼미션 확인 팝업 OK 
![hackers_8th_04](https://hackers-n8n-lecture.s3.ap-northeast-2.amazonaws.com/images/hackers_8th_04.png)

![hackers_8th_05](https://hackers-n8n-lecture.s3.ap-northeast-2.amazonaws.com/images/hackers_8th_05.png)

#### Bot 토큰 설정
- Bot 사이드 Bot 진입
- ICON 필요 시 새로 설정
- USERNAME 표시 이름 정함
- Reset Token 선택 
	- 오래 걸릴 시 Cancel 후 비번 입력 
- Bot Permission 
	- Admin 혹은 , TEXT PERMISSIONS 필요 내용 선별
	- Privileged Gateway Intents
		- Message Content Intent : Enable
			- 추후 메시지 분석을 위해 사용

#### n8n credential 설정
- n8n 에서 Connect Type : Bot Token 
- Credential for Discord Bot API 
	- 신규 생성 후 Bot Token 에 복사

![hackers_8th_06](https://hackers-n8n-lecture.s3.ap-northeast-2.amazonaws.com/images/hackers_8th_06.png)

### Webhook 방식

#### 채널에서 웹후크 설정 
- 채널 셋팅
- 연동 -> 웹후크 만들기 
	- 웹후크 URL 복사

![hackers_8th_07](https://hackers-n8n-lecture.s3.ap-northeast-2.amazonaws.com/images/hackers_8th_07.png)


#### n8n credential 설정
- Connect Type : Webhook
- Credential for Discord Webhook
	-  Webhook URL 기입 

![hackers_8th_08](https://hackers-n8n-lecture.s3.ap-northeast-2.amazonaws.com/images/hackers_8th_08.png)

## 8-4 시나리오 완성

### 1단계: 📰 최신 뉴스 수집 및 필터링

워크플로우의 시작 부분으로, 여러 IT 매체에서 최신 뉴스를 자동으로 가져와 가장 중요한 3개의 기사만 선별하는 과정입니다.

  * **⏰ `Schedule Trigger`**: 워크플로우를 매일 아침 7시에 자동으로 시작합니다.
  * **⚙️ `Define RSS Feeds`**: Set 노드를 사용하여 정보를 가져올 4개의 RSS 피드 URL 목록을 정의합니다.
```json
[
  "https://techcrunch.com/feed/",
  "https://www.engadget.com/rss.xml",
  "https://www.wired.com/feed/rss",
  "https://theverge.com/rss/index.xml"
]
```
  * **↔️ `Split Feeds`**: `Split Out` 노드로 각 RSS 피드를 개별 아이템으로 분리하여 하나씩 처리할 수 있도록 준비합니다.
  * **📰 `Read RSS Feed`**: 분리된 각 URL을 읽어 기사 목록 전체를 가져옵니다.
      * **URL**: `{{ $json.rss }}`
  * **⚙️ `RSS source ADD`**: 어떤 기사가 어느 매체에서 왔는지 출처를 명확히 하기 위해 원본 RSS 주소를 각 기사 데이터에 추가합니다.
  * **📊 `Sort by Date`**: 모든 기사를 `isoDate`(작성일) 필드 기준으로 최신순(**descending**)으로 정렬합니다.
  * **⬇️ `Limit 3`**: 정렬된 기사 중 **가장 최신 3개**의 기사만 다음 단계로 넘깁니다.
	  * 실제 테스트 할 때 데이터 수를 줄여서 유용하게 쓰임

-----

### 2단계: 🤖 AI 콘텐츠 생성 및 데이터 저장 (루프)

선별된 3개의 기사를 하나씩 반복하며, AI를 통해 요약 및 이미지 생성을 하고 구글 드라이브와 구글 시트에 차곡차곡 저장하는 핵심 단계입니다.

  * **↔️ `Loop Over Items`**: `Split In Batches` 노드를 **Batch Size: 1**로 설정하여 3개의 기사를 하나씩 반복 처리합니다.
  * **🧠 `Message a model (Gemini)`**: 현재 기사 본문을 Gemini AI를 통해 5줄의 핵심 내용으로 요약합니다.
	  * api key 
		  * https://aistudio.google.com/api-keys 에서 발급 
		  * 해당 내용으로 credential 생성 
      * **Prompt**:
        ```
        다음 하기 기사를 5줄 불릿포인트로 요약해주세요.
        요약된 내용만 출력해주세요. "다음은 요약입니다." 와 같은 본문 이외에 필요 없는 말은 하지마세요

        {{ $json.content }}
        ```
  * **🧠 `Generate an image (Gemini)`**: 요약된 기사 내용에 가장 잘 어울리는 이미지를 AI로 생성합니다.
      * **Prompt**:
        ```
        하기 컨텐츠에 어울리는 이미지를 생성해줘
        {{ $('Loop Over Items').item.json.contentSnippet }}
        ```
  * **🖼️ `Upload file (Google Drive)`**: 생성된 이미지를 구글 드라이브의 지정된 폴더에 업로드합니다.
      * **File Name**: `{{ $('Loop Over Items').item.json.title.replace(/ /g, '_').replace(/[^\w.-]/g, '') }}`
      * 올리기 전에 해당 폴더를 `anyone with the link , viewer`  옵션으로 share 필요
  * **🗒️ `Add Contents (Google Sheets)`**: 기사 제목, AI 요약, 구글 드라이브 이미지 링크 등 생성된 모든 콘텐츠를 구글 시트에 한 줄씩 추가하여 기록합니다.
      * **ID**: `{{ $now.toMillis() }}`
      * **Date**: `{{ $now.format('yyyy-MM-dd') }}`
      * **Article Title**: `{{ $('Loop Over Items').item.json.title }}`
      * **Summary**: `{{ $('Message a model').item.json.content.parts[0].text }}`
      * **image**: `{{ $json.webContentLink.includes('&export=download') ? $json.webContentLink.replace('&export=download', '&export=view') : $json.webContentLink }}`
> Google Sheet 컬럼 구성
> ID	Date	Article Title	Source	URL	Summary	image	imagePreview	Status	Twitter/X Link
> 
> imagePreview에서 `=IMAGE(G2,1)` 이렇게 하면 Preview 볼 수 있음



-----

### 3단계: 👍 사람의 승인 및 상태 업데이트

자동으로 생성된 콘텐츠를 발행하기 전, 사람이 중간에 확인하고 승인(또는 거절)하는 **'Human in the Loop'** 과정입니다.

  * **💬 `Need to Approve in Discord`**: 디스코드 채널에 승인 요청 메시지를 \*\*'Approve'\*\*와 **'Reject'** 버튼과 함께 보냅니다.
      * **Message**:
        ```
        **✅ SNS 게시 승인 요청이 도착했습니다.**

        **- ID:** {{ $json.ID }}
        **- 제목:** {{ $json["Article Title"] }}
        **- 출처:** {{ $json.Source }}
        **- 원문 링크:** {{ $json.URL }}

        **- 요약:**
        {{ $json.Summary }}

        {{ $json.image }}
        ```
  * **🔀 `Switch`**: 디스코드에서 누른 버튼(`{{ $json.data.approved }}`) 결과에 따라 다음 흐름을 **승인(Approve)** 또는 **거절(Reject)** 경로로 분기합니다.
	  * if node 보다 추천됨 
	  * case 별 이름 지을 수 있음 

#### 👉 승인 (Approve) 경로

1.  **💬 `X posted Send Message (Discord)`**: 승인 처리되었음을 알리는 확인 메시지를 디스코드에 다시 보냅니다.
2.  **🗒️ `Update Approved Status (Google Sheets)`**: 구글 시트에서 해당 콘텐츠의 **'Status'** 컬럼을 \*\*'Approve'\*\*로 업데이트합니다.
      * **Matching Column (ID)**: `{{ $('Add Contents').item.json.ID }}`

#### 👉 거절 (Reject) 경로

1.  **🗒️ `Reject Write (Google Sheets)`**: 구글 시트에서 해당 콘텐츠의 **'Status'** 컬럼을 \*\*'Reject'\*\*로 업데이트합니다.
      * **Matching Column (ID)**: `{{ $('Add Contents').item.json.ID }}`
