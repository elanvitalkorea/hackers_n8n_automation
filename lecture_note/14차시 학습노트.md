## 14차시: [n8n 실전 프로젝트 6] 뉴스 기사 Smart RAG 파이프라인 만들기

안녕하세요, 여러분. 13차시에서는 무거운 백엔드 작업을 처리하기 위해 별도의 서버를 구축하고, Dockerfile을 작성하여 Render와 GCP Cloud Run에 배포하는 전문적인 CaaS/PaaS 경험을 했습니다.

이제 14차시에서는 우리 과정의 핵심 주제인 **AI Agent와 RAG**의 정수를 다룹니다.

단순히 문서를 벡터 DB에 저장하고 검색하는 것을 넘어, 수집한 데이터가 \*\*'나의 목표'\*\*에 부합하는지 AI가 스스로 평가하고, 가치 있는 정보만 선별하여 저장하며, 강력한 하이브리드 검색 에이전트를 통해 필요한 인사이트를 도출하는 \*\*'Smart RAG 파이프라인'\*\*을 구축할 것입니다.

이번 차시는 `AI News Curation 시스템 설계 문서`를 기반으로, n8n, Supabase, AI Agent가 결합된 가장 강력한 프로젝트를 완성합니다.

-----

### 14-1. 데이터 중복 방지 워크플로우

우리의 목표는 '정보의 무덤'을 만드는 것이 아니라 '가치 있는 인사이트 저장소'를 만드는 것입니다. 이를 위해 RAG 파이프라인 설계 시 가장 중요한 \*\*'2-Table 아키텍처'\*\*를 도입합니다.

이는 Supabase(PostgreSQL)의 장점을 극대화하는 방식으로, '원본 관리'와 '벡터 검색'을 분리합니다.

  * **문제점:** 만약 모든 정보를 하나의 거대한 벡터 테이블(`documents`)에만 저장하면, 기사 중복 체크가 어렵고, 원본 기사의 상태(예: 평가 중, 저장 완료)를 관리할 수 없으며, 'High 등급 기사 목록' 같은 메타데이터 검색이 비효율적이 됩니다.

  * **해결책: 2-Table 아키텍처** (`AI News Curation 시스템 설계 문서` 기반)

    1.  **테이블 1: `articles` (Record Manager - 원본/상태 관리)**

          * **역할:** 파이프라인의 '상태'를 관리하고, 기사 '원본'의 모든 메타데이터를 저장합니다. (1기사 = 1행)
          * **핵심 (중복 방지):** `link TEXT UNIQUE NOT NULL`
              * 기사 링크(URL)에 `UNIQUE` 제약조건을 걸어, n8n 워크플로우가 이미 수집한 기사를 다시 삽입하려 하면 DB단에서 자동으로 막아줍니다.
          * **핵심 (상태 관리):** `status TEXT DEFAULT 'pending' NOT NULL`
              * 기사의 현재 상태(`pending` -\> `evaluating` -\> `stored` / `rejected`)를 추적하여 워크플로우의 안정성을 높입니다.

    2.  **테이블 2: `documents` (Vector Store - RAG 검색용)**

          * **역할:** 실제 '검색 대상'이 되는 텍스트 '청크(chunk)'와 임베딩을 저장합니다. (1기사 = N행)
          * **핵심 (연결):** `metadata JSONB`
              * 이 청크가 어떤 `articles` 테이블의 행(원본 기사)에서 왔는지(`article_id`, `link`, `title` 등)를 저장합니다.
              * 이를 통해 벡터 검색 시 `articles` 테이블을 매번 참조(JOIN)하지 않고도 기본적인 정보를 빠르게 반환할 수 있습니다.

#### n8n 수집 워크플로우 (전체 시나리오 요약)

이 2-Table 구조를 기반으로, n8n 수집 워크플로우는 다음과 같은 'Smart RAG' 파이프라인의 큰 얼개를 구성합니다.

1.  **[1단계: 중복 체크]**

      * n8n이 RSS 피드에서 기사 목록을 읽어옵니다.
      * `Supabase` 노드를 사용해 기사의 `link`를 기준으로 `articles` 테이블을 조회합니다.
      * `IF` 노드가 조회 결과(중복 여부)를 확인합니다. 이미 `articles` 테이블에 `link`가 존재하면 워크플로우를 즉시 중단합니다.

2.  **[2단계: AI 평가]**

      * 중복이 아닌 새 기사일 경우, `articles` 테이블에 `status='pending'`으로 기본 행을 삽입합니다.
      * 이후 14-2에서 정의할 **'AI 평가 프롬프트'** (`OpenAI` 노드)를 호출하여 기사의 `grade` (High, Medium, Low)와 `reason`을 받습니다.
      * `status`를 `evaluating`으로 업데이트합니다.

3.  **[3단계: 분기 처리 및 저장]**

      * n8n `IF` 노드는 2단계에서 받은 `grade` 평가에 따라 작업을 분기합니다.
      * **If `grade` is `Low` or `Medium`:**
          * 워크플로우가 종료됩니다. `articles` 테이블의 `status`를 `rejected`로 업데이트합니다.
          * **(결과)** 불필요한 크롤링, AI 요약, 벡터 임베딩 비용(돈과 시간)을 절약합니다.
      * **If `grade` is `High`:**
        1.  **본문 크롤링:** `FireCrawl` 노드 등으로 기사 본문을 크롤링합니다.
        2.  **상세 요약:** `OpenAI` 노드가 크롤링된 본문을 상세히 요약합니다.
        3.  **메타데이터 저장:** `Supabase` 노드가 `articles` 테이블에 요약문, `grade`, `reason` 등을 업데이트합니다.
        4.  **벡터 저장:** `Supabase Vector Store` 노드가 본문을 청킹(Chunking)하여 `documents` (벡터 테이블)에 임베딩하여 저장합니다.
        5.  **상태 완료:** `Supabase` 노드가 `articles` 테이블의 `status`를 `stored`로 최종 업데이트합니다.

이 전체 과정을 통해 우리는 가치 있는 정보만 선별하여 `articles` (메타데이터)와 `documents` (벡터 데이터)에 동시 적재하는 파이프라인을 완성합니다.

-----

### 14-2. 기사 적합도 평가 및 목표 설정 (AI 평가)

'Smart RAG'의 핵심은 **모든 정보를 저장하지 않는 것**입니다. 우리는 AI를 '평가자'로 활용하여, 수집된 뉴스가 우리의 근본적인 목표와 일치하는지 검증합니다.

#### 1\. 목표 정의 (Root Cause Gem)

자동화를 구축하기 전, '왜(Why)' 하는지 알아야 합니다. `Root Cause Gem 대화`에서 5 Whys Q\&A 과정을 통해 우리의 근본 목표를 도출했습니다.

> **[확정된 근본 목표 (Confirmed Root Goal)]**
>
> AI 기술(Agent, RAG)을 활용해 다방면의 정보에 '인사이트'를 부여하는 가치 있는 작업을 통해 유료 뉴스레터와 AI 사업을 성공시키고, 궁극적으로 '경제적 자유'를 달성하는 것.

#### 2\. 평가 프롬프트 적용

이 '근본 목표'는 AI 평가 프롬프트의 핵심 `Goal` 섹션에 그대로 삽입됩니다. 14-1의 수집 워크플로우 2단계에서 이 프롬프트를 사용합니다.

  * **1단계: 평가 프롬프트 (모든 기사)** (`AI News Curation 시스템 설계 문서` 기반)



```prompt
당신은 AI 기술 전문가이자 유료 뉴스레터 크리에이터입니다.

### Goal
"AI 기술(Agent, RAG)을 활용해 다방면의 정보에 '인사이트'를 부여하는 가치 있는 작업을 통해 유료 뉴스레터와 AI 사업을 성공시키고, 궁극적으로 '경제적 자유'를 달성하는 것"

### 페르소나
1. AI 기술 전문가
2. 콘텐츠 크리에이터
...
3. 경제적 자유 추구자
---

### 평가 기준
1. AI Agent, RAG, LLM 기술 진보
2. AI 사업 아이디어 도출
3. 수익화 가능성
---
### 출력 (JSON)
{
  "grade": "High|Medium|Low",
  "reason": "이 기사는 [내용]을 다루며, [목표와의 연관성]"
}
```

-----

### 14-3. 인사이트 도출 AI Agent 구성 (조회)

이제 'High' 등급으로 엄선된 고품질 데이터가 `articles`와 `documents` 테이블에 저장되었습니다. 마지막 단계는 이 데이터를 자유롭게 조회할 수 있는 AI Agent를 구성하는 것입니다.

#### 1\. 하이브리드 Tool 사용 (Vector + Article)

LLM의 성능을 극대화하기 위해, n8n Agent에 두 가지 강력한 도구(Tool)를 제공합니다.

1.  **`news_vector_store` (Vector Tool):**

      * **대상:** `documents` 테이블
      * **용도:** 의미 기반의 '정성적/맥락적' 검색 (예: "RAG의 최신 기술 동향이 뭐야?")
      * `AI News Curation 시스템 설계 문서`의 `v3 조회 워크플로우`에 이 도구가 포함되어 있습니다.

2.  **`article_table_query` (Article/SQL Tool):**

      * **대상:** `articles` 테이블
      * **용도:** `relevance_grade`, `published_at` 등 메타데이터 기반의 '정량적/사실적' 검색 (예: "지난주 High 등급 기사 목록 보여줘.")
      * `v3 조회 워크플로우`에 이 도구가 포함되어 있습니다.

#### 2\. 기본 검색 시나리오 (Agent Tool 호출)

이 두 가지 도구를 결합하면 다음과 같은 복합적인 질문에 대응할 수 있습니다.

  * **"open ai 투자 관련 뉴스 기사 찾아주세요"**
      * **Agent 행동:** `news_vector_store` (Vector Tool)를 호출하여 의미가 유사한 기사 청크를 검색합니다.
  * **"아마존 관련 기사에 대해서 전문 요약해주세요"**
      * **Agent 행동 (2단계):**
        1.  `news_vector_store`로 '아마존' 관련 기사를 검색하여 `article_id`를 확보합니다.
        2.  `article_table_query` (Article Tool)를 호출하여 해당 `article_id`의 `content` (본문) 또는 `summary` (요약)를 조회합니다.
  * **"인프라 투자 관련 기사를 찾아 트렌드를 요약해주세요"**
      * **Agent 행동:** `news_vector_store` (Vector Tool)를 호출하여 여러 기사의 청크를 종합해 트렌드를 요약합니다.
  * **"위 기사들이 벡터 DB에 추천이 되어 등록된 이유가 무엇인지 확인해주세요"**
      * **Agent 행동 (2단계):**
        1.  (컨텍스트에서 `article_id`를 인지합니다)
        2.  `article_table_query` (Article Tool)를 호출하여 해당 `article_id`의 `alignment_reason` ('High' 등급 부여 이유) 컬럼을 조회합니다.

#### 3\. (참고) 검색 강화 시나리오 (개념 확장)

> 🔔 **참고:** 이 부분은 실제 실습하지 않으며, AI Agent의 '두뇌'를 업그레이드하여 두 도구를 최적으로 조합하는 방법을 위한 개념적인 아이디어 제공입니다.

AI Agent가 사용자의 질문 의도를 분석하여 이 두 도구를 최적으로 조합하도록 '통합 검색 에이전트 프롬프트'를 적용할 수 있습니다.

**시나리오 1: SQL-ONLY (정량/메타데이터 검색)**

  * **사용자 질문:** "이번 주 'High' 등급 받은 기사 목록과 그 이유(`alignment_reason`)를 알려줘."
  * **Agent 행동:** `article_table_query` 도구만 사용하여 `articles` 테이블을 조회합니다.

**시나리오 2: Vector-ONLY (정성/맥락 검색)**

  * **사용자 질문:** "수집된 기사들 바탕으로 'Llama 3'의 학습 데이터셋 논란에 대해 요약해줘."
  * **Agent 행동:** `news_vector_store` 도구만 사용하여 `documents` 테이블에서 관련 청크를 검색합니다.

**시나리오 3: HYBRID (SQL → Vector) (가장 강력함)**

  * **사용자 질문:** "이번 달 **'AI Agent'** 관련 기사 중 **'High' 등급**을 받은 기사들만 **[SQL]** 찾아서, 그 기사들이 공통으로 언급하는 **핵심 성공 과제**가 뭔지 요약해줘 **[Vector]**."
  * **Agent 행동 (2단계):**
    1.  `article_table_query`를 호출하여 `relevance_grade = 'High'` AND `title` LIKE '%AI Agent%'인 기사의 `article_id` 목록을 가져옵니다.
    2.  `news_vector_store`를 호출하여 "핵심 성공 과제"를 검색하되, \*\*필터(filter)\*\*를 적용하여 1번에서 찾은 `article_id` 목록 내에서만 검색합니다.

이로써 우리는 단순히 정보를 수집하는 것을 넘어, **'목표에 따라 평가하고, 선별하여 저장하며, 두 가지 도구를 복합적으로 사용해 조회하는'** 진정한 'Smart RAG 파이프라인'을 완성했습니다.